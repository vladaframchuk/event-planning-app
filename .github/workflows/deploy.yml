name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Derive repository name
        id: repo
        run: echo "value=${GITHUB_REPOSITORY##*/}" >> "$GITHUB_OUTPUT"

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ steps.repo.outputs.value }}-backend:latest
            ghcr.io/${{ github.repository_owner }}/${{ steps.repo.outputs.value }}-backend:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ steps.repo.outputs.value }}-backend:latest
          cache-to: type=inline

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=https://event-planning-app.ru
            NEXT_PUBLIC_BACKEND_URL=https://event-planning-app.ru
            NEXT_PUBLIC_WS_URL=wss://event-planning-app.ru/ws
            NODE_ENV=production
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ steps.repo.outputs.value }}-frontend:latest
            ghcr.io/${{ github.repository_owner }}/${{ steps.repo.outputs.value }}-frontend:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ steps.repo.outputs.value }}-frontend:latest
          cache-to: type=inline

  deploy_prod:
    runs-on: ubuntu-latest
    needs: build_and_push
    environment:
      name: production
      url: https://event-planning-app.ru
    permissions:
      contents: read
    steps:
      - name: Prepare SSH configuration
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          install -m 700 -d ~/.ssh
          printf '%s' "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          printf '%s' "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts

      - name: Derive repository name
        id: repo
        run: echo "value=${GITHUB_REPOSITORY##*/}" >> "$GITHUB_OUTPUT"

      - name: Upload deployment inputs
        env:
          BACKEND_TAG: ${{ github.sha }}
          FRONTEND_TAG: ${{ github.sha }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          REGISTRY_IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/${{ steps.repo.outputs.value }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          python - "$BACKEND_TAG" "$FRONTEND_TAG" "$GHCR_USERNAME" "$GHCR_TOKEN" "$REGISTRY_IMAGE_PREFIX" <<'PY'
import os
import pathlib
from sys import argv

back, front, user, token, prefix = argv[1:6]
lines = [
    f"BACKEND_TAG={back}",
    f"FRONTEND_TAG={front}",
    f"GHCR_USERNAME={user}",
    f"GHCR_TOKEN={token}",
    f"REGISTRY_IMAGE_PREFIX={prefix}",
]
pathlib.Path("deploy_inputs.env").write_text("\n".join(lines), encoding="utf-8")
PY
          scp -i ~/.ssh/id_rsa deploy_inputs.env "${SSH_USER}@${SSH_HOST}:~/event-planning-app/deploy_inputs.env"
          rm deploy_inputs.env

      - name: Deploy to production
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          ssh -i ~/.ssh/id_rsa "${SSH_USER}@${SSH_HOST}" "set -euo pipefail; cd ~/event-planning-app; set -a; source deploy_inputs.env; set +a; rm deploy_inputs.env; ./scripts/deploy.sh"
